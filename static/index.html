<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf8">
		<title>SoundBarrel</title>
		<link rel="stylesheet" type="text/css" href="main.css">
        <link rel="stylesheet" type="text/css" href="http://taitems.github.io/Aristo-jQuery-UI-Theme/css/Aristo/Aristo.css">
        <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
		<script src="./jquery.cookie.js"></script>
        <script src="http://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
		<script type="text/javascript">
var path = window.location.pathname, genre, userid = "1";
if(/^[a-x]+$/.exec(path) == null) {
  // bad path
  genre = "electro";
}
genre = path.substring(1);
    
$(document).ready(function() {
  $.ajax({
    "url" : "/fetchGenre",
    "type" : "GET",
    "data" : {
      "genre" : genre,
      "id" : userid
    },
    "success" : function(data) {
			// do something with the loaded content
			var songs = data.players;//JSON.parse(request.responseText);
      var containers = $(".iframeMusic");
      for(i=0; i<containers.length; i++) {
        containers[i].innerHTML = "<iframe width='920' height='166' scrolling='no' frameborder='no' src='https://w.soundcloud.com/player/?url=" + songs[i] + "&amp;color=666699&amp;auto_play=false&amp;hide_related=true&amp;show_artwork=true'></iframe>";
      }
		}
  });
  
  var progress = $("#progressbar"),
      progressBarText = $("#progressBarText");
  
  $("#doneSorting").click(function() {
    
    var newPercent = parseInt(progress.attr("aria-valuenow")) + 10;
    console.log({
        "genre" : genre,
        "id" : userid,
        "order" : [],
        "percent" : newPercent
      });
    $.ajax({
      "url" : "/updateGenre",
      "type" : "POST",
      "data" : {
        "genre" : genre,
        "id" : userid,
        "order" : [],
        "percent" : newPercent
      },
      "success" : function(data) {
        // do something with the loaded content
        var songs = data.players;//JSON.parse(request.responseText);
        var containers = $(".iframeMusic");
        for(i=0; i<containers.length; i++) {
          containers[i].innerHTML = "<iframe width='920' height='166' scrolling='no' frameborder='no' src='https://w.soundcloud.com/player/?url=" + songs[i] + "&amp;color=666699&amp;auto_play=false&amp;hide_related=true&amp;show_artwork=true'></iframe>";
        }
        progress.progressbar({value: newPercent});
        progressBarText.text(newPercent + "%");
      }
    });
  });
    
    
  function roundToNearest(origVal, placeVal, xDiffn) {
      var addX = origVal * 241;
      xDiff = xDiffn-(placeVal-origVal)*241;
      if(xDiff >= 482 && placeVal < 1) {
          return {pVal: placeVal+2, newX: (placeVal+2)*241 - addX};
      } else if(xDiff > 241 && placeVal < 2) {
          console.log("yey");
          return {pVal: placeVal+1, newX: (placeVal+1)*241 - addX};
      } else if(xDiff > 0) {
          return {pVal: placeVal, newX: (placeVal+0)*241 - addX};
      } else if(xDiff < -482 && placeVal > 1) {
          return {pVal: placeVal-2, newX: (placeVal-2)*241 - addX}; }
      else if(xDiff < -241 && placeVal > 0) {
          return {pVal: placeVal-1, newX: (placeVal-1)*241 - addX};
      } else { return {pVal: placeVal, newX: 0 - origVal}; }
  }
  (function($) {
      $.fn.drags = function(opt) {

          opt = $.extend({handle:"",cursor:"move"}, opt);

          if(opt.handle === "") {
              var $el = this;
          } else {
              var $el = this.find(opt.handle);
          }

          return $el.css('cursor', opt.cursor).on("mousedown", function(e) {
              if(this.id == "musicPlayer1") {
                  $("#iframeDivFixer1").css("display", "block");
              } else if(this.id == "musicPlayer2") {
                  $("#iframeDivFixer2").css("display", "block");
              } else if(this.id == "musicPlayer3") {
                  $("#iframeDivFixer3").css("display", "block");
              }
              if(opt.handle === "") {
                  var $drag = $(this).addClass('draggable');
              } else {
                  var $drag = $(this).addClass('active-handle').parent().addClass('draggable');
              }
              var z_idx = $drag.css('z-index'),
                      drg_h = $drag.outerHeight(),
                      drg_w = $drag.outerWidth(),
                      pos_y = $drag.offset().top + drg_h - e.pageY,
                      pos_x = $drag.offset().left + drg_w - e.pageX;
              $drag.css('z-index', 1000).parents().on("mousemove", function(e) {
                  $('.draggable').offset({
                      top:e.pageY + pos_y - drg_h,
                      left:e.pageX + pos_x - drg_w
                  }).off("mouseup").on("mouseup", function() {
                              if(this.id == "musicPlayer1") {
                                  $("#iframeDivFixer1").css("display", "none");
                              } else if(this.id == "musicPlayer2") {
                                  $("#iframeDivFixer2").css("display", "none");
                              } else if(this.id == "musicPlayer3") {
                                  $("#iframeDivFixer3").css("display", "none");
                              }
                              newVals = (roundToNearest(parseInt($(this).attr("origVal")), parseInt($(this).attr("placeVal")), parseInt($(this).css("top").split("px")[0])));
                              oldPVal = $(this).attr("placeVal");
                              $(this).css("top", newVals.newX + "px").css("left","0");
                              $(".musicPlayer").each(function() {
                                  var curPVal = parseInt($(this).attr("placeVal"));
                                  var oldInt = parseInt(oldPVal);
                                  var newInt = parseInt(newVals.pVal);
                                  if(curPVal == oldInt) {
                                      return;
                                  }
                                  if(curPVal < oldInt && curPVal < newInt) return;
                                  if(curPVal > oldInt && curPVal > newInt) return;
                                  if(oldInt < curPVal && newInt >= curPVal) {
                                      $(this).css("top", (parseInt($(this).css("top").split("px")[0])-241) + "px");
                                      $(this).attr("placeVal", parseInt($(this).attr("placeVal"))-1);
                                  }
                                  if(oldInt > curPVal && newInt <= curPVal) {
                                      $(this).css("top", (parseInt($(this).css("top").split("px")[0])+241) + "px");
                                      $(this).attr("placeVal", parseInt($(this).attr("placeVal"))+1);
                                  }
                                  console.log("changed");
                              });
                              $(this).attr("placeVal", newVals.pVal)
                              $(this).removeClass('draggable').css('z-index', z_idx);

                              $('.draggable').off("mousemove");
                              $('.draggable').off("mouseup");
                              $(this).off("mouseup");
                              $(this).off("mousemove");
                              $(this).parents().off("mousemove");
                          });
              });
              e.preventDefault(); // disable selection
          }).on("mouseup", function() {
                      if(this.id == "musicPlayer1") {
                          $("#iframeDivFixer").css("display", "none");
                      }
                      if(opt.handle === "") {
                          $(this).removeClass('draggable');
                      } else {
                          $(this).removeClass('active-handle').parent().removeClass('draggable');
                      }
                      $(this).off("mouseup");
                      $('#musicPlayer1').off("mouseup");
                  });

      }
  })(jQuery);
  $(function() {
      $("#progressbar").progressbar({value: 0});
      $(".musicPlayer").drags();
  });
});

function storeGenre(selection) {
  //var store = {"id":createID(), "genre":selection, "percentage":33.3};
  //$.cookie('soundbarrelUserSession', JSON.stringify(store), {expires:3, path:'/'});
  window.location= "/" + selection.toLowerCase();
}
		</script>
	</head>
	<body style="margin:0px; padding:0px;">
		<div id="bodyContainer">
            <div class="header">
                <div id="logo">
                    <img src="soundbarrel.png" id="logoImg">
                </div>

                <div id="genreDiv">
                    <select id="genreselect" onchange="storeGenre($('#genreselect').val())">
                        <option value="Alternative">Alternative</option>
                        <option value="Blues">Ambient</option>
                        <option value="Classical">Classical</option>
                        <option value="Country">Country</option>
                        <option value="Electronic">Electronic</option>
                        <option value="Folk">Folk</option>
                        <option value="Jazz">Jazz</option>
                        <option value="Indie">Metal</option>
                        <!--<option value="Hip Hop">Hip Hop</option>-->
                        <option value="Pop">Pop</option>
                        <option value="Rock">Rock</option>
                    </select>
                </div>

                <ul id="menu">
                    <li class="centrepiece menuItem">
                        <h2><a href="#">SIGNUP</a></h2>
                    </li>
                    <li class="centrepiece menuItem">
                        <h2><a href="#">LOG IN</a></h2>
                    </li>
                </ul>

            </div>
            <div id="innerBody">
                <div id="outerButtonDiv">
                    <span id="progressBarText">0%</span>
                    <div id="progressbar"></div>
                    <button><a href="#" class="button" id="doneSorting">I'm done sorting! Show me new songs!</a></button>
                </div>
            </div>
            <div id="musicPlayers"> <ul id="musicPlayerList">
                <li><div class="musicPlayer" id="musicPlayer1" placeVal=0 origVal=0 style="z-index: auto; position: relative; top: 0px; left: 0px;">
                    <div id="iframeDivFixer1" class="ui-draggable-iframeFix" style="background-color: rgb(255, 255, 255); display: none; width: 920px; height: 166px; position: absolute; opacity: 0.001; z-index: 1000;"></div>
                    <div class="iframeMusic">
                        <!--<iframe width="920" height="166" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/86256527&amp;color=666699&amp;auto_play=false&amp;hide_related=true&amp;show_artwork=true"></iframe>-->
                    </div>
                </div></li>
                <li><div class="musicPlayer" id="musicPlayer2" placeVal=1 origVal=1 style="z-index: auto; position: relative; top: 0px; left: 0px;">
                    <div id="iframeDivFixer2" class="ui-draggable-iframeFix" style="background-color: rgb(255, 255, 255); display: none; width: 920px; height: 166px; position: absolute; opacity: 0.001; z-index: 1000;"></div>
                    <div class="iframeMusic">
                        <!--<iframe width="920" height="166" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/111779418&amp;color=666699&amp;auto_play=false&amp;hide_related=true&amp;show_artwork=true"></iframe>-->
                    </div>
                </div></li>
                <li><div class="musicPlayer" id="musicPlayer3" placeVal=2 origVal=2 style="z-index: auto; position: relative; top: 0px; left: 0px;">
                    <div id="iframeDivFixer3" class="ui-draggable-iframeFix" style="background-color: rgb(255, 255, 255); display: none; width: 920px; height: 166px; position: absolute; opacity: 0.001; z-index: 1000;"></div>
                    <div class="iframeMusic">
                        <!--<iframe width="920" height="166" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/140779152&amp;color=666699&amp;auto_play=false&amp;hide_related=true&amp;show_artwork=true"></iframe>-->
                    </div>
                </div></li>
            </ul> </div>
        </div>
        </body>
</html>